(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2730],{2516:(e,t,a)=>{Promise.resolve().then(a.bind(a,7138))},6202:(e,t,a)=>{"use strict";a.d(t,{A:()=>o});var l=a(5155),r=a(2115),n=a(4073),i=a(9434);let o=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,l.jsxs)(n.bL,{ref:t,className:(0,i.cn)("relative flex w-full touch-none select-none items-center",a),...r,children:[(0,l.jsx)(n.CC,{className:"relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20",children:(0,l.jsx)(n.Q6,{className:"absolute h-full bg-primary"})}),(0,l.jsx)(n.zi,{className:"block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50"})]})});o.displayName=n.bL.displayName},7138:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>N});var l=a(5155),r=a(2115),n=a(5695),i=a(285),o=a(9576),s=a(6927),c=a(2523),d=a(5057),u=a(1394),m=a(7933),p=a(3833);a(4534);var h=a(4165),g=a(6202);async function f(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,l=document.createElement("canvas"),r=l.getContext("2d");if(!r)throw Error("No 2d context");let n=e.naturalWidth/e.width,i=e.naturalHeight/e.height;l.width=Math.floor(t.width*n*1),l.height=Math.floor(t.height*i*1),r.scale(1,1),r.imageSmoothingQuality="high";let o=t.x*n,s=t.y*i,c=e.naturalWidth/2,d=e.naturalHeight/2;return r.save(),r.translate(-o,-s),r.translate(c,d),r.scale(a,a),r.translate(-c,-d),r.drawImage(e,0,0,e.naturalWidth,e.naturalHeight,0,0,e.naturalWidth,e.naturalHeight),r.restore(),new Promise((e,t)=>{l.toBlob(a=>{if(!a){console.error("Canvas is empty"),t(Error("Canvas is empty"));return}e(a)},"image/png")})}function x(e){let{isOpen:t,onClose:a,imageSrc:n,aspect:o,circularCrop:s=!1,onApply:c,title:u="Edit photo"}=e,m=(0,r.useRef)(null),[x,v]=(0,r.useState)(),[b,y]=(0,r.useState)(),[w,j]=(0,r.useState)(1),[N,C]=(0,r.useState)(null);(0,r.useEffect)(()=>{n&&(v(void 0),y(void 0),j(1),C(null))},[n]);let k=async()=>{if(C(null),!b||!m.current||!n){console.error("Crop details, image ref, or image source not available"),C("Could not apply crop. Please ensure an image is loaded and selected.");return}if(0===b.width||0===b.height)return void C("Invalid crop dimensions. Please select an area to crop.");try{let e=await f(m.current,b,w);e?(c(e),a()):C("Failed to generate cropped image.")}catch(t){console.error("Error cropping image:",t);let e=t instanceof Error?t.message:"Unknown error";C("Could not crop the image: ".concat(e,". Please try again."))}},S=()=>{C(null),a()};return(0,l.jsx)(h.lG,{open:t,onOpenChange:e=>!e&&S(),children:(0,l.jsxs)(h.Cf,{className:"sm:max-w-[625px] bg-black text-white border-gray-800",children:[(0,l.jsx)(h.c7,{children:(0,l.jsx)(h.L3,{className:"text-white",children:u})}),N&&(0,l.jsx)("p",{className:"text-sm text-red-600 px-6 pb-2",children:N}),(0,l.jsx)("div",{className:"relative flex justify-center items-center overflow-hidden p-4",style:{maxHeight:"70vh"},children:n?(0,l.jsxs)("div",{className:"flex flex-col items-center space-y-4 w-full",children:[(0,l.jsx)(p.Ay,{crop:x,onChange:(e,t)=>v(t),onComplete:e=>y(e),aspect:o,circularCrop:s,keepSelection:!0,children:(0,l.jsx)("img",{ref:m,alt:"Crop preview",src:n,style:{transform:"scale(".concat(w,")"),objectFit:"contain",width:"100%",height:"auto",maxHeight:"60vh"},onLoad:function(e){let{width:t,height:a}=e.currentTarget;if(t>0&&a>0)v((0,p.ge)((0,p.dS)({unit:"%",width:90},o,t,a),t,a));else C("Could not load image dimensions.")},onError:()=>C("Failed to load image for cropping.")})}),(0,l.jsxs)("div",{className:"w-full max-w-xs flex items-center space-x-2 mt-4 px-4 self-center",children:[(0,l.jsx)(d.J,{htmlFor:"zoom",className:"w-12 text-sm text-gray-400",children:"Zoom"}),(0,l.jsx)(g.A,{id:"zoom",min:1,max:3,step:.01,value:[w],onValueChange:e=>j(e[0]),className:"flex-1 [&>span:first-child]:h-1 [&>span:first-child>span]:bg-white [&>span:last-child]:bg-gray-600 [&>span:last-child]:border-0"})]})]}):(0,l.jsx)("p",{className:"text-gray-400",children:"No image selected for cropping."})}),(0,l.jsxs)(h.Es,{className:"bg-black pt-4 pb-6 px-6 border-t border-gray-800 sm:justify-between",children:[(0,l.jsx)(i.$,{type:"button",variant:"ghost",onClick:S,className:"text-white hover:bg-gray-700",children:"Cancel"}),(0,l.jsx)(i.$,{type:"button",onClick:k,disabled:!b||0===b.width||0===b.height||!n,className:"bg-red-600 hover:bg-red-700 text-white",children:"Apply"})]})]})})}function v(e){let{id:t,label:a,initialImageUrl:n=null,aspect:o,circularCrop:s=!1,onFileChange:p,disabled:h=!1,previewType:g="avatar",buttonText:f="Change Picture",modalTitle:v="Edit photo"}=e,[b,y]=(0,r.useState)(n),[w,j]=(0,r.useState)(null),[N,C]=(0,r.useState)(!1),k=(0,r.useRef)(null),[S,E]=(0,r.useState)(null);(0,r.useEffect)(()=>{y(n)},[n]);let P=()=>{var e;null==(e=k.current)||e.click()};return(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsx)(d.J,{htmlFor:t,className:"text-sm font-medium",children:a}),S&&(0,l.jsx)("p",{className:"text-sm text-red-600",children:S}),(0,l.jsx)(c.p,{id:t,type:"file",accept:"image/png, image/jpeg, image/webp",ref:k,onChange:e=>{var t;E(null);let a=null==(t=e.target.files)?void 0:t[0];if(a){if(!a.type.startsWith("image/")){E("Invalid file type. Please select an image."),k.current&&(k.current.value="");return}let e=new FileReader;e.onloadend=()=>{j(e.result),C(!0)},e.onerror=()=>{E("Failed to read the selected file."),j(null)},e.readAsDataURL(a)}else j(null);k.current&&(k.current.value="")},className:"hidden",disabled:h}),"banner"===g?(0,l.jsxs)("div",{className:"relative w-full h-32 bg-muted rounded-md border border-dashed border-border flex items-center justify-center cursor-pointer hover:border-primary transition-colors",onClick:P,title:"Click to change banner",children:[b?(0,l.jsx)("img",{src:b,alt:"".concat(a," Preview"),className:"w-full h-full object-cover rounded-md"},b):(0,l.jsxs)("span",{className:"text-muted-foreground text-sm",children:["Click to upload ",a.toLowerCase()]}),(0,l.jsx)("div",{className:"absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity rounded-md",children:(0,l.jsx)(m.A,{className:"text-white h-8 w-8"})})]}):(0,l.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,l.jsxs)("div",{className:"relative cursor-pointer",onClick:P,title:"Click to change ".concat(a.toLowerCase()),children:[(0,l.jsxs)(u.eu,{className:"w-24 h-24 border-2 border-muted",children:[(0,l.jsx)(u.BK,{src:null!=b?b:void 0,alt:"".concat(a," Preview")},b),(0,l.jsx)(u.q5,{className:"text-3xl",children:"??"})]}),(0,l.jsx)("div",{className:"absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity rounded-full",children:(0,l.jsx)(m.A,{className:"text-white h-6 w-6"})})]}),(0,l.jsx)(i.$,{type:"button",variant:"link",size:"sm",onClick:P,disabled:h,className:"text-sm",children:f})]}),"banner"===g&&(0,l.jsx)(i.$,{type:"button",variant:"link",size:"sm",onClick:P,disabled:h,className:"text-sm -mt-1",children:f}),w&&(0,l.jsx)(x,{isOpen:N,onClose:()=>{C(!1),j(null)},imageSrc:w,aspect:o,circularCrop:s,onApply:e=>{E(null);let a=null==w?void 0:w.match(/data:image\/(.+);/),l=a?a[1]:"png",r=new File([e],"".concat(t,"_cropped_").concat(Date.now(),".").concat(l),{type:"image/".concat(l)});y(URL.createObjectURL(e)),p(r),C(!1),j(null)},title:v})]})}function b(e){let{id:t,label:a,initialVideoUrl:n=null,onFileChange:o,disabled:s=!1,buttonText:u="Change Video"}=e,[p,h]=(0,r.useState)(n),g=(0,r.useRef)(null),[f,x]=(0,r.useState)(null);(0,r.useEffect)(()=>{h(n)},[n]);let v=()=>{var e;null==(e=g.current)||e.click()};return(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsx)(d.J,{htmlFor:t,className:"text-sm font-medium",children:a}),f&&(0,l.jsx)("p",{className:"text-sm text-red-600",children:f}),(0,l.jsx)(c.p,{id:t,type:"file",accept:"video/mp4, video/webm, video/quicktime, video/ogg",ref:g,onChange:e=>{var t;x(null);let a=null==(t=e.target.files)?void 0:t[0];if(a){if(!a.type.startsWith("video/")){x("Invalid file type. Please select a video."),g.current&&(g.current.value=""),o(null),h(n);return}h(URL.createObjectURL(a)),o(a)}else h(n),o(null);g.current&&(g.current.value="")},className:"hidden",disabled:s}),(0,l.jsxs)("div",{className:"relative w-full h-32 bg-muted rounded-md border border-dashed border-border flex items-center justify-center cursor-pointer hover:border-primary transition-colors",onClick:v,title:"Click to change ".concat(a.toLowerCase()),children:[p?(0,l.jsx)("video",{src:p,className:"w-full h-full object-cover rounded-md",autoPlay:!0,loop:!0,muted:!0,playsInline:!0},p):(0,l.jsxs)("span",{className:"text-muted-foreground text-sm",children:["Click to upload ",a.toLowerCase()]}),(0,l.jsx)("div",{className:"absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity rounded-md",children:(0,l.jsx)(m.A,{className:"text-white h-8 w-8"})})]}),(0,l.jsx)(i.$,{type:"button",variant:"link",size:"sm",onClick:v,disabled:s,className:"text-sm -mt-1",children:u})]})}let y=e=>{if(!e)return null;try{var t;let a=null==(t=new URL(e).pathname.split(".").pop())?void 0:t.toLowerCase();if(a&&["mp4","webm","mov","ogg","mkv","avi"].includes(a))return"video";return a&&["png","jpg","jpeg","gif","webp"].includes(a),"image"}catch(t){return console.warn("Could not parse URL to determine media type:",e,t),null}};function w(e){let{initialProfileImageUrl:t,initialBannerImageUrl:a,initialProfilePath:n,initialBannerPath:c,onSave:d,onCancel:u}=e,{user:m}=(0,o.As)(),[p,h]=(0,r.useState)(null),[g,f]=(0,r.useState)(null),[x,w]=(0,r.useState)(!1),[j,N]=(0,r.useState)(null),[C,k]=(0,r.useState)(y(a));(0,r.useEffect)(()=>{g?k(g.type.startsWith("video/")?"video":"image"):k(y(a))},[g,a]);let S=async(e,t,a)=>{var l;if(!m)throw Error("User not authenticated.");let r=t.name.split(".").pop(),i="".concat(a,".").concat(r),o="".concat(m.id,"/").concat(i),d=t.type;console.log("Uploading ".concat(a," (").concat(d,") to: ").concat(e,"/").concat(o));let u="profile"===a?n:c;if(u)try{console.log("Attempting to remove old ".concat(a," file from storage: ").concat(u));let{error:t}=await s.N.storage.from(e).remove([u]);t&&"The resource was not found"!==t.message?console.warn("Failed to remove old ".concat(a," file at ").concat(u,":"),t.message):t||console.log("Successfully removed old ".concat(a," file: ").concat(u))}catch(t){let e=t instanceof Error?t.message:String(t);console.warn("Error during removal of old ".concat(a," file:"),e)}else console.log("No initial ".concat(a," path provided for deletion."));let{data:p,error:h}=await s.N.storage.from(e).upload(o,t,{cacheControl:"3600",upsert:!0,contentType:d});if(h)throw console.error("Upload error for ".concat(a,":"),h),Error("Failed to upload ".concat(a," file: ").concat(h.message));return console.log("Successfully uploaded ".concat(a," to ").concat(null==p?void 0:p.path)),null!=(l=null==p?void 0:p.path)?l:null},E=async e=>{if(e.preventDefault(),!m)return void N("Cannot save images. User not authenticated.");if(!p&&!g)return void N("No new images or videos selected to save.");w(!0),N(null);try{let e,t;if(p&&(e=await S("avatars",p,"profile"),null===e))throw Error("Failed to get profile picture storage path after upload.");if(g&&(t=await S("banners",g,"banner"),null===t))throw Error("Failed to get banner image storage path after upload.");let a={updated_at:new Date().toISOString()},l=!1;if(void 0!==e&&(a.profile_picture_url=e,l=!0),void 0!==t&&(a.banner_image_url=t,l=!0),l){console.log("Updating profile images data in DB:",a);let{error:e}=await s.N.from("profiles").update(a).eq("id",m.id);if(e)throw console.error("Database update error:",e),Error("Failed to update profile data: ".concat(e.message));console.log("Profile images updated successfully in DB!")}else console.log("No new files were uploaded, skipping database update.");d()}catch(t){let e=t instanceof Error?t.message:String(t);console.error("Failed to update profile images:",t),N("Failed to update images: ".concat(e,". Please try again."))}finally{w(!1)}};return(0,l.jsx)(r.Fragment,{children:(0,l.jsxs)("form",{onSubmit:E,className:"space-y-6 p-4 border rounded-lg shadow-sm bg-card",children:[j&&(0,l.jsx)("p",{className:"text-sm text-red-600 mb-4",children:j}),"video"===C?(0,l.jsx)(b,{id:"bannerVideo",label:"Banner Video",initialVideoUrl:a,onFileChange:f,disabled:x,buttonText:"Change Banner"}):(0,l.jsx)(v,{id:"bannerImage",label:"Banner Image",initialImageUrl:a,aspect:16/9,circularCrop:!1,onFileChange:f,disabled:x,previewType:"banner",buttonText:"Change Banner",modalTitle:"Edit banner photo"}),(0,l.jsx)(v,{id:"profilePicture",label:"Profile Picture",initialImageUrl:t,aspect:1,circularCrop:!0,onFileChange:h,disabled:x,previewType:"avatar",buttonText:"Change Picture",modalTitle:"Edit profile photo"}),(0,l.jsxs)("div",{className:"flex justify-end space-x-3 pt-4",children:[(0,l.jsx)(i.$,{type:"button",variant:"outline",onClick:u,disabled:x,children:"Cancel"}),(0,l.jsx)(i.$,{type:"submit",disabled:x||!p&&!g,children:x?"Saving...":"Save Changes"})]})]})})}var j=a(4304);function N(){let e=(0,n.useRouter)(),{user:t}=(0,o.As)(),[a,i]=(0,r.useState)(null),[c,d]=(0,r.useState)(null),[u,m]=(0,r.useState)(null),[p,h]=(0,r.useState)(null),[g,f]=(0,r.useState)(!0),[x,v]=(0,r.useState)(null);return(0,r.useEffect)(()=>{(async()=>{if(!t){v("User not authenticated."),f(!1);return}f(!0),v(null);try{var e,a;let{data:l,error:r}=await s.N.from("profiles").select("profile_picture_url, banner_image_url").eq("id",t.id).single();if(r)if("PGRST116"===r.code)console.log("Profile not found, initializing with null images.");else throw r;let n=null!=(e=null==l?void 0:l.profile_picture_url)?e:null,o=null!=(a=null==l?void 0:l.banner_image_url)?a:null;m(n),h(o),i(n?s.N.storage.from("avatars").getPublicUrl(n).data.publicUrl:null),d(o?s.N.storage.from("banners").getPublicUrl(o).data.publicUrl:null)}catch(t){let e=t instanceof Error?t.message:String(t);console.error("Failed to fetch profile data:",t),v("Failed to load profile images: ".concat(e))}finally{f(!1)}})()},[t,e]),(0,l.jsx)(j.MainLayout,{children:(0,l.jsxs)("div",{className:"container mx-auto px-4 py-8",children:[(0,l.jsx)("h1",{className:"text-2xl font-bold mb-6",children:"Edit Profile Images"}),g&&(0,l.jsx)("p",{children:"Loading profile data..."}),x&&(0,l.jsxs)("p",{className:"text-red-600",children:["Error: ",x]}),!g&&!x&&t&&(0,l.jsx)(w,{initialProfileImageUrl:a,initialBannerImageUrl:c,initialProfilePath:u,initialBannerPath:p,onSave:()=>{console.log("Profile images saved successfully, navigating back."),e.push("/profile/edit")},onCancel:()=>{console.log("Image editing cancelled."),e.back()}}),!g&&!t&&!x&&(0,l.jsx)("p",{children:"Please log in to edit your profile images."})]})})}}},e=>{var t=t=>e(e.s=t);e.O(0,[2111,6711,4206,851,3953,6671,1733,3568,8312,1144,4550,7328,9022,7431,3762,4304,8441,1684,7358],()=>t(2516)),_N_E=e.O()}]);