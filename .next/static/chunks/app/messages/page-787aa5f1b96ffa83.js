(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9451],{3896:(e,t,s)=>{"use strict";function n(e){return[].concat(e)}function r(e){return e.startsWith(":")}function i(e){return o(e)&&("*"===e||e.length>1&&":>~.+*".includes(e.slice(0,1))||c(e))}function a(e,t){return(o(t)||"number"==typeof t)&&"--"!==e&&!r(e)&&!l(e)}function l(e){return e.startsWith("@media")}s.d(t,{_:()=>v,cx:()=>function e(...t){return d(t.reduce((t,s)=>(s instanceof Set?t.push(...s):"string"==typeof s?t.push(s):Array.isArray(s)?t.push(e(...s)):"object"==typeof s&&Object.entries(s).forEach(([e,s])=>{s&&t.push(e)}),t),[])," ").trim()}});function o(e){return e+""===e}function c(e){return o(e)&&(e.startsWith("&")||r(e))}function d(e,t=""){return e.filter(Boolean).join(t)}function u(e,t){let s=0;if(0===t.length)return s.toString();for(let e=0;e<t.length;e++)s=(s<<5)-s+t.charCodeAt(e),s&=s;return`${e??"cl"}_${s.toString(36)}`}var h=class e{constructor(e,t,s,n){this.sheet=e,this.property=t,this.value=s,this.selector=n,this.property=t,this.value=s,this.joined=`${t}:${s}`;let r=this.selector.preconditions.concat(this.selector.postconditions);this.hash=this.selector.hasConditions?this.selector.scopeClassName:u(this.sheet.name,this.joined),this.key=d([this.joined,r,this.hash])}toString(){let t=m(this.selector.preconditions,{right:this.hash});return t=m(this.selector.postconditions,{left:t}),`${t} {${e.genRule(this.property,this.value)}}`}static genRule(e,t){var s,n;return s=e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase(),n="content"===e?`"${t}"`:t,`${s}:${n};`}};function m(e,{left:t="",right:s=""}={}){let n=e.reduce((e,t)=>r(t)?e+t:c(t)?e+t.slice(1):d([e,t]," "),t);return d([n,s?`.${s}`:""]," ")}var f=class e{constructor(e,t=null,{preconditions:s,postconditions:r}={}){this.sheet=e,this.preconditions=[],this.scopeClassName=null,this.scopeName=null,this.postconditions=[],this.preconditions=s?n(s):[],this.postconditions=r?n(r):[],this.setScope(t)}setScope(e){return e&&(this.scopeClassName||(this.scopeName=e,this.scopeClassName=u(this.sheet.name,e+this.sheet.count))),this}get hasConditions(){return this.preconditions.length>0||this.postconditions.length>0}addScope(t){return new e(this.sheet,t,{preconditions:this.preconditions,postconditions:this.postconditions})}addPrecondition(t){return new e(this.sheet,this.scopeClassName,{postconditions:this.postconditions,preconditions:this.preconditions.concat(t)})}addPostcondition(t){return new e(this.sheet,this.scopeClassName,{preconditions:this.preconditions,postconditions:this.postconditions.concat(t)})}createRule(e,t){return new h(this.sheet,e,t,this)}},g=class{constructor(e,t){this.name=e,this.rootNode=t,this.storedStyles={},this.storedClasses={},this.style="",this.count=0,this.id=`flairup-${e}`,this.styleTag=this.createStyleTag()}getStyle(){return this.style}append(e){var t;this.style=(t=this.style,t?`${t}
${e}`:e)}apply(){this.count++,this.styleTag&&(this.styleTag.innerHTML=this.style)}isApplied(){return!!this.styleTag}createStyleTag(){if("undefined"==typeof document||this.isApplied()||null===this.rootNode)return this.styleTag;let e=document.createElement("style");return e.type="text/css",e.id=this.id,(this.rootNode??document.head).appendChild(e),e}addRule(e){let t=this.storedClasses[e.key];return o(t)?t:(this.storedClasses[e.key]=e.hash,this.storedStyles[e.hash]=[e.property,e.value],this.append(e.toString()),e.hash)}};function p(e,t){for(let s in e)t(s.trim(),e[s])}function v(e,t){let s=new g(e,t);return{create:function(e){let t={};return(function e(t,s,n){let r=[];return p(s,(a,l)=>{if(i(a))return e(t,l,n.addPrecondition(a)).forEach(e=>r.push(e));r.push([a,s[a],n.addScope(a)])}),r})(s,e,new f(s)).forEach(([e,r,o])=>{(function e(t,s,r){let o=new Set;return p(s,(s,c)=>{let d=[];if(i(s))d=e(t,c,r.addPostcondition(s));else if("."===s)d=n(c);else if(l(s))d=function(t,s,n,r){t.append(n+" {");let i=e(t,s,r);return t.append("}"),i}(t,c,s,r);else if("--"===s)d=function(t,s,n){let r=new Set,i=[];if(p(s,(s,l)=>{if(a(s,l))return void i.push(h.genRule(s,l));x(e(t,l??{},n),r)}),!n.scopeClassName)return r;if(i.length){let e=i.join(" ");t.append(`${m(n.preconditions,{right:n.scopeClassName})} {${e}}`)}return r.add(n.scopeClassName),r}(t,c,r);else if(a(s,c)){let e=r.createRule(s,c);t.addRule(e),o.add(e.hash)}return x(d,o)}),o})(s,r,o).forEach(s=>{var n,r;n=e,r=s,t[n]=t[n]??new Set,t[n].add(r)})}),s.apply(),t},getStyle:s.getStyle.bind(s),isApplied:s.isApplied.bind(s)}}function x(e,t){return e.forEach(e=>t.add(e)),t}},6349:(e,t,s)=>{"use strict";s.d(t,{default:()=>j});var n=s(5155),r=s(2115),i=s(5695),a=s(6424),l=s(1394),o=s(2523),c=s(285),d=s(9911),u=s(351),h=s(4996),m=s(9434),f=s(9576),g=s(6927),p=s(3568);let v=(e,t)=>{if((null==e?void 0:e.participant_uids)&&Array.isArray(e.participant_uids))return e.participant_uids.find(e=>e!==t)},x=e=>{if(!e)return"";let t=new Date(e);if(isNaN(t.getTime()))return"";let s=new Date,n=new Date(s);return(n.setDate(s.getDate()-1),t.toDateString()===s.toDateString())?t.toLocaleTimeString(void 0,{hour:"numeric",minute:"2-digit"}):t.toDateString()===n.toDateString()?"Yesterday":t.toLocaleDateString(void 0,{month:"short",day:"numeric"})},y=e=>{var t,s,r,i,a,o;let{conversation:c,isSelected:d,onClick:u,currentUserId:h}=e,f=v(c,h),g=f?null==(t=c.participantDetails)?void 0:t[f]:void 0,p=c.last_message_content,y=c.last_message_sender_uid,w=c.last_message_created_at,N=null!=(i=null==(s=c.unreadCount)?void 0:s[h])?i:0;return g?(0,n.jsxs)("div",{className:(0,m.cn)("flex items-center p-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors rounded-md mb-1",d&&"bg-gray-100 dark:bg-gray-800"),onClick:u,children:[(0,n.jsx)("div",{className:"relative",children:(0,n.jsx)(l.eu,{className:"h-12 w-12",children:(0,n.jsx)(l.q5,{children:null!=(a=null==(r=g.username)?void 0:r.substring(0,2).toUpperCase())?a:"??"})})}),(0,n.jsxs)("div",{className:"ml-3 flex-1 overflow-hidden",children:[(0,n.jsxs)("div",{className:"flex justify-between items-center",children:[(0,n.jsx)("p",{className:"font-medium truncate",children:null!=(o=g.username)?o:"Unknown User"}),w&&(0,n.jsx)("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:x(w)})]}),(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[p&&(0,n.jsxs)("p",{className:(0,m.cn)("text-sm truncate text-gray-500 dark:text-gray-400 max-w-[70%]",N>0&&"font-semibold text-gray-800 dark:text-gray-200"),children:[y===h?"You: ":"",p]}),N>0&&(0,n.jsx)("span",{className:"bg-blue-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center",children:N})]})]})]}):(0,n.jsxs)("div",{className:"flex items-center p-3 h-[72px] animate-pulse",children:[(0,n.jsx)("div",{className:"h-12 w-12 rounded-full bg-gray-300 dark:bg-gray-700"}),(0,n.jsxs)("div",{className:"ml-3 flex-1 space-y-2",children:[(0,n.jsx)("div",{className:"h-4 bg-gray-300 dark:bg-gray-700 rounded w-3/4"}),(0,n.jsx)("div",{className:"h-3 bg-gray-300 dark:bg-gray-700 rounded w-1/2"})]})]})},w=e=>{var t,s;let{message:r,isOwnMessage:i,showAvatar:a=!0,senderProfile:o}=e,c=o?(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(l.q5,{children:null!=(s=null==(t=o.username)?void 0:t.substring(0,2).toUpperCase())?s:"??"})}):(0,n.jsx)("div",{className:"h-full w-full rounded-full bg-gray-300 dark:bg-gray-700 animate-pulse"});return(0,n.jsxs)("div",{className:"flex ".concat(i?"justify-end":"justify-start"," mb-4"),children:[!i&&a&&(0,n.jsx)(l.eu,{className:"h-8 w-8 mr-2 mt-1 flex-shrink-0",children:c}),(0,n.jsxs)("div",{className:"max-w-[70%]",children:[(0,n.jsx)("div",{className:(0,m.cn)("px-4 py-2 rounded-2xl text-sm break-words",i?"bg-blue-500 text-white rounded-bl-none":"bg-gray-200 dark:bg-gray-800 text-gray-900 dark:text-gray-100 rounded-br-none"),children:r.content}),(0,n.jsx)("div",{className:"flex text-xs text-gray-500 mt-1 ".concat(i?"justify-end":"justify-start"),children:(0,n.jsx)("span",{children:x(r.created_at)})})]}),i&&a&&(0,n.jsx)(l.eu,{className:"h-8 w-8 ml-2 mt-1 flex-shrink-0",children:c})]})},N=e=>{let{onSendMessage:t,onTypingChange:s,disabled:i=!1}=e,[a,l]=(0,r.useState)(""),[u,m]=(0,r.useState)(!1),f=(0,r.useRef)(null),g=(0,r.useRef)(null),p=(0,r.useRef)(null);(0,r.useEffect)(()=>{let e=e=>{g.current&&e.target instanceof Node&&!g.current.contains(e.target)&&m(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),(0,r.useEffect)(()=>()=>{p.current&&clearTimeout(p.current)},[]);let v=()=>{a.trim()&&!i&&(t(a),l(""),m(!1),p.current&&clearTimeout(p.current),s(!1,""))};return(0,n.jsx)("div",{className:"p-3 border-t border-gray-200 dark:border-gray-700",children:(0,n.jsxs)("div",{className:"relative flex items-center",children:[(0,n.jsxs)("div",{className:"relative",children:[(0,n.jsx)(c.$,{variant:"ghost",size:"icon",type:"button",onClick:()=>m(!u),className:"text-gray-500",disabled:i,children:(0,n.jsx)(d.Ky9,{className:"h-5 w-5"})}),u&&(0,n.jsx)("div",{className:"absolute bottom-12 left-0 z-10",ref:g,children:(0,n.jsx)(h.Ay,{onEmojiClick:e=>{var t;l(t=>t+e.emoji),null==(t=f.current)||t.focus()},theme:h.Sx.AUTO,width:320,height:400})})]}),(0,n.jsx)(o.p,{ref:f,className:"flex-1 mx-2",placeholder:i?"Select a conversation":"Type a message...",value:a,onChange:e=>{let t=e.target.value;l(t),p.current&&clearTimeout(p.current),t.trim()?s(!0,t):s(!1,t)},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),v())},disabled:i}),(0,n.jsx)(c.$,{variant:"ghost",size:"icon",type:"button",onClick:v,disabled:!a.trim()||i,className:"text-blue-500 ".concat(!a.trim()||i?"opacity-50 cursor-not-allowed":""),children:(0,n.jsx)(d.Cer,{className:"h-5 w-5"})})]})})};function j(){var e,t,s,d,h;let{user:x,loading:j}=(0,f.As)(),b=(0,i.useSearchParams)(),[S,E]=(0,r.useState)(null),[_,k]=(0,r.useState)([]),[C,R]=(0,r.useState)(""),[T,D]=(0,r.useState)([]),[U,I]=(0,r.useState)("list"),[P,M]=(0,r.useState)(!0),[A,$]=(0,r.useState)(!1),[L,O]=(0,r.useState)({}),[z,F]=(0,r.useState)(null),[W,q]=(0,r.useState)(null),[B,H]=(0,r.useState)(!1),[K,Y]=(0,r.useState)(!1),V=(0,r.useRef)(null),Z=(0,r.useRef)(null),G=(0,r.useRef)(null),J=(0,r.useRef)(null),Q=(0,r.useRef)(_);(0,r.useEffect)(()=>{Q.current=_},[_]);let X=(0,r.useCallback)(async e=>{if(!e)return console.warn("fetchUserProfile called with invalid userId"),null;if(L[e])return L[e];try{let{data:t,error:s}=await g.N.from("profiles").select("id, username").eq("id",e).maybeSingle();if(s)throw s;if(t)return O(s=>({...s,[e]:t})),t;{console.warn("User profile not found for ID: ".concat(e));let t={id:e,username:"Unknown User"};return O(s=>({...s,[e]:t})),t}}catch(t){return t instanceof Error?t.message:String(t),console.error("Error fetching user profile for ".concat(e,":"),t),null}},[L]),ee=(0,r.useCallback)(async e=>{let t=e.participant_uids||[],s=t.filter(e=>!L[e]);s.length>0&&await Promise.all(s.map(X));let n=t.reduce((e,t)=>(L[t]&&(e[t]=L[t]),e),{});return{...e,participantDetails:n}},[X,L]);(0,r.useEffect)(()=>{(null==x?void 0:x.id)&&!L[x.id]&&X(x.id)},[x,L,X]),(0,r.useEffect)(()=>{let e=b.get("userId");b.get("conversationId"),e&&e!==(null==x?void 0:x.id)?(F(e),E(null),q(null),D([]),window.innerWidth<768&&I("chat")):(F(null),q(null))},[b,null==x?void 0:x.id]),(0,r.useEffect)(()=>{z&&!L[z]?X(z).then(e=>{e?q(e):(p.oR.error("Could not load profile for user ID: ".concat(z)),F(null))}):z&&L[z]&&q(L[z])},[z,X,L]),(0,r.useEffect)(()=>{if(!(null==x?void 0:x.id))return k([]),M(!1),()=>{Z.current&&(g.N.removeChannel(Z.current),Z.current=null)};M(!0),(async()=>{try{let{data:e,error:t}=await g.N.from("conversations").select("*").contains("participant_uids",[x.id]).order("updated_at",{ascending:!1});if(t)throw t;if(e){let t=await Promise.all(e.map(e=>ee(e)));k(t);let s=b.get("conversationId"),n=b.get("userId");if(s){let e=t.find(e=>e.id===s);e?(E(e.id),F(null),q(null),window.innerWidth<768&&I("chat")):console.warn("Conversation ID ".concat(s," from URL not found."))}else if(n&&n!==x.id){let e=t.find(e=>e.participant_uids.includes(n));e?(E(e.id),F(null),q(null)):E(null),window.innerWidth<768&&I("chat")}}else k([])}catch(e){e instanceof Error?e.message:String(e),console.error("Error fetching initial conversations:",e),p.oR.error("Failed to load conversations.")}finally{M(!1)}})();let e=async e=>{console.log("Conversation change received:",e);let t=e.new,s=e.old,n=t;"DELETE"!==e.eventType&&t&&(n=await ee(t)),k(r=>{let i=[...r],a=i.findIndex(e=>{var n;return e.id===(null!=(n=null==t?void 0:t.id)?n:null==s?void 0:s.id)});return"INSERT"===e.eventType&&n?-1===a?i.push(n):i[a]=n:"UPDATE"===e.eventType&&n?-1!==a?i[a]=n:i.push(n):"DELETE"===e.eventType&&s&&(i=i.filter(e=>e.id!==s.id),S===s.id&&(E(null),D([]))),i.sort((e,t)=>new Date(t.updated_at).getTime()-new Date(e.updated_at).getTime()),i})};return Z.current&&g.N.removeChannel(Z.current),Z.current=g.N.channel("conversations:".concat(x.id)).on("postgres_changes",{event:"*",schema:"public",table:"conversations",filter:'participant_uids=cs.{"'.concat(x.id,'"}')},e).subscribe((e,t)=>{"SUBSCRIBED"===e&&console.log("Subscribed to conversations channel"),("CHANNEL_ERROR"===e||"TIMED_OUT"===e)&&(console.error("Conversation subscription error:",e,t),p.oR.error("Realtime connection issue. Try refreshing."))}),()=>{Z.current&&(g.N.removeChannel(Z.current),Z.current=null,console.log("Unsubscribed from conversations channel"))}},[null==x?void 0:x.id,ee,b]);let et=(0,r.useMemo)(()=>{var e;return null!=(e=_.find(e=>e.id===S))?e:null},[S,_]);(0,r.useEffect)(()=>{if(G.current&&(g.N.removeChannel(G.current).then(()=>console.log("Unsubscribed from previous messages/presence channel")).catch(e=>console.error("Error unsubscribing:",e)),G.current=null),Y(!1),!S||!(null==x?void 0:x.id)){D([]),$(!1);return}$(!0),(async()=>{try{let{data:e,error:t}=await g.N.from("messages").select("*").eq("conversation_id",S).order("created_at",{ascending:!0}).limit(100);if(t)throw t;if(e){let t=new Set(e.map(e=>e.sender_uid));await Promise.all(Array.from(t).map(e=>X(e))),D(e)}else D([])}catch(e){e instanceof Error?e.message:String(e),console.error("Error fetching initial messages:",e),p.oR.error("Failed to load messages.")}finally{$(!1)}})();let e=async e=>{if(console.log("Message change received:",e),"INSERT"===e.eventType){let t=e.new;await X(t.sender_uid),console.log("--- handleNewMessage: Received new message data ---",t),D(e=>e.some(e=>e.id===t.id)?(console.log("--- handleNewMessage: Message already exists in state ---"),e):(console.log("--- handleNewMessage: Adding new message to state ---"),[...e,t]))}else console.log("--- handleNewMessage: Received non-INSERT event ---",e.eventType)},t=()=>{var e;console.log("--- handlePresenceSync: Fired ---");let t=Q.current.find(e=>e.id===S);if(!G.current||!(null==x?void 0:x.id)||!t)return void console.log("--- handlePresenceSync: Aborting (no channel, user, or selected convo) ---");let s=G.current.presenceState();console.log("--- handlePresenceSync: Current presence state ---",s);let n=v(t,x.id);if(!n)return void Y(!1);let r=s[n],i=null!=(e=null==r?void 0:r.some(e=>!0===e.typing))&&e;console.log("--- handlePresenceSync: Other user (".concat(n,") is typing: ").concat(i," ---")),Y(i)},s=g.N.channel("messages-presence:".concat(S),{config:{presence:{key:x.id}}}).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:"conversation_id=eq.".concat(S)},e).on("presence",{event:"sync"},()=>{console.log("--- Presence Event: sync ---"),t()}).on("presence",{event:"join"},e=>{let{key:s,newPresences:n}=e;console.log("--- Presence Event: join ---",{key:s,newPresences:n}),t()}).on("presence",{event:"leave"},e=>{let{key:t,leftPresences:s}=e;console.log("--- Presence Event: leave ---",{key:t,leftPresences:s});let n=Q.current.find(e=>e.id===S);t===(n?v(n,x.id):null)&&Y(!1)}).subscribe(async(e,t)=>{if("SUBSCRIBED"===e){console.log("Subscribed to messages/presence channel for conversation ".concat(S));try{let e=await s.track({typing:!1});console.log("--- Subscription: Initial presence track status ---",e)}catch(e){console.error("--- Subscription: Error tracking initial presence ---",e)}}else console.log("--- Subscription: Status changed to ".concat(e," ---"));t?(console.error("--- Subscription: Error ---",e,t),p.oR.error("Realtime connection error: ".concat(t.message))):"CHANNEL_ERROR"===e||"TIMED_OUT"===e?(console.error("--- Subscription: Channel Error/Timeout ---",e),p.oR.error("Realtime connection issue. Try refreshing.")):"CLOSED"===e&&console.log("--- Subscription: Channel closed ---")});return G.current=s,()=>{G.current&&(G.current.untrack().then(()=>g.N.removeChannel(G.current)).then(()=>console.log("Untracked and unsubscribed from messages/presence channel")).catch(e=>console.error("Error unsubscribing/untracking:",e)),G.current=null)}},[S,null==x?void 0:x.id,X]),(0,r.useEffect)(()=>{let e=setTimeout(()=>{var e;null==(e=V.current)||e.scrollIntoView({behavior:"smooth"})},100);return()=>clearTimeout(e)},[T]),(0,r.useEffect)(()=>{let e=()=>{window.innerWidth>=768&&I("list")};return window.addEventListener("resize",e),e(),()=>window.removeEventListener("resize",e)},[]);let es=(0,r.useMemo)(()=>_.filter(e=>{var t;if(!(null==x?void 0:x.id))return!1;let s=v(e,x.id);if(!s)return!1;let n=L[s];return!!n&&(null==(t=n.username)?void 0:t.toLowerCase().includes(C.toLowerCase()))}),[_,null==x?void 0:x.id,L,C]),en=async(e,t)=>{if(!(null==x?void 0:x.id)||!e||x.id===e)return void p.oR.error("Invalid users for conversation.");if(B)return;H(!0);let s=t.trim();if(!s)return void H(!1);try{let t=await X(e);if(!t||"Unknown User"===t.username)throw Error("Recipient profile not found or incomplete.");let{data:n,error:r}=await g.N.from("conversations").select("id").contains("participant_uids",[x.id,e]).limit(1).maybeSingle();if(r)throw r;if(n)console.log("Existing conversation found:",n.id),E(n.id),F(null),q(null),window.innerWidth<768&&I("chat"),await er(s,n.id),p.oR.success("Existing conversation selected.");else{console.log("Creating new conversation...");let{data:t,error:n}=await g.N.from("conversations").insert({participant_uids:[x.id,e],last_message_content:s,last_message_sender_uid:x.id,last_message_created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(n||!t)throw n||Error("Failed to create conversation.");let r=t.id;console.log("New conversation created:",r);let{error:i}=await g.N.from("messages").insert({conversation_id:r,sender_uid:x.id,content:s});if(i)throw console.error("Error inserting first message, conversation created but message failed:",i),i;E(r),F(null),q(null),window.innerWidth<768&&I("chat"),p.oR.success("Conversation started!")}}catch(t){let e=t instanceof Error?t.message:String(t);console.error("Error in createConversationAndSendMessage:",t),p.oR.error("Failed to start conversation: ".concat(e||"Unknown error"))}finally{H(!1)}},er=async(e,t)=>{let s=e.trim(),n=null!=t?t:S;if(!s||!(null==x?void 0:x.id)||!n){console.error("Cannot send message: Missing content, user ID, or conversation ID.",{trimmedContent:s,userId:null==x?void 0:x.id,conversationIdToSend:n}),p.oR.error("Cannot send message. Please select a conversation.");return}let r={conversation_id:n,sender_uid:x.id,content:s};try{let{error:e}=await g.N.from("messages").insert(r);if(e)throw e;g.N.from("conversations").update({last_message_content:s,last_message_sender_uid:x.id,last_message_created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",n).then(e=>{let{error:t}=e;t&&console.warn("Message sent, but failed to update conversation metadata:",t)})}catch(e){console.error("Error sending message:",e),p.oR.error("Failed to send message.")}finally{J.current&&clearTimeout(J.current),ei(!1)}},ei=e=>{G.current&&(null==x?void 0:x.id)&&(!e&&J.current&&(clearTimeout(J.current),J.current=null),G.current.track({typing:e}).then(e=>{"ok"!==e&&console.warn("Presence track failed:",e)}).catch(e=>console.error("Error tracking presence:",e)),e&&(J.current&&clearTimeout(J.current),J.current=setTimeout(()=>{J.current=null},3e3)))},ea=e=>{E(e.id),F(null),q(null),D([]),window.innerWidth<768&&I("chat")};if(j)return(0,n.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,n.jsx)(u.TwU,{className:"animate-spin h-8 w-8 text-blue-500"})});if(!x)return(0,n.jsx)("div",{className:"flex items-center justify-center h-full text-center text-gray-500",children:"Please log in to view your messages."});let el=(0,r.useMemo)(()=>{if(et){let e=v(et,x.id);return e?L[e]:null}return W||null},[et,W,null==x?void 0:x.id,L]);return(0,n.jsxs)("div",{className:"flex flex-1 h-full bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 overflow-hidden",children:[(0,n.jsxs)("div",{className:(0,m.cn)("w-full md:w-1/3 lg:w-1/4 border-r border-gray-200 dark:border-gray-800 flex flex-col h-full","chat"===U&&"hidden md:flex"),children:[(0,n.jsxs)("div",{className:"p-4 border-b border-gray-200 dark:border-gray-800 flex-shrink-0",children:[(0,n.jsxs)("h1",{className:"text-xl font-bold mb-4 flex items-center",children:[(0,n.jsx)(u.mEP,{className:"mr-2"})," Messages"]}),(0,n.jsxs)("div",{className:"relative",children:[(0,n.jsx)(u.CKj,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"}),(0,n.jsx)(o.p,{placeholder:"Search conversations...",className:"pl-10",value:C,onChange:e=>R(e.target.value)})]})]}),(0,n.jsx)(a.F,{className:"flex-1",children:(0,n.jsx)("div",{className:"p-3",children:P?(0,n.jsx)("div",{className:"flex justify-center items-center py-4",children:(0,n.jsx)(u.TwU,{className:"animate-spin h-6 w-6 text-blue-500"})}):0!==es.length||z?es.map(e=>(0,n.jsx)(y,{conversation:e,isSelected:S===e.id,onClick:()=>ea(e),currentUserId:x.id},e.id)):(0,n.jsx)("p",{className:"text-center text-gray-500 my-4",children:"No conversations found"})})})]}),(0,n.jsx)("div",{className:(0,m.cn)("flex-1 flex flex-col h-full","list"===U&&"hidden md:flex"),children:S||W?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"p-3 border-b border-gray-200 dark:border-gray-800 flex items-center flex-shrink-0",children:[(0,n.jsx)(c.$,{variant:"ghost",size:"icon",className:"mr-2 md:hidden",onClick:()=>{I("list"),E(null),F(null),q(null)},children:(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,n.jsx)("path",{fillRule:"evenodd",d:"M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 111.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z",clipRule:"evenodd"})})}),el?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(l.eu,{className:"h-10 w-10",children:(0,n.jsx)(l.q5,{children:null!=(t=null==(e=el.username)?void 0:e.substring(0,2).toUpperCase())?t:"??"})}),(0,n.jsx)("div",{className:"ml-3",children:(0,n.jsx)("p",{className:"font-medium",children:null!=(s=el.username)?s:"Unknown User"})}),(0,n.jsx)("div",{className:"ml-auto",children:(0,n.jsx)(c.$,{variant:"ghost",size:"icon",children:(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"})})})})]}):(0,n.jsxs)("div",{className:"flex items-center animate-pulse w-full",children:[(0,n.jsx)("div",{className:"h-10 w-10 rounded-full bg-gray-300 dark:bg-gray-700"}),(0,n.jsxs)("div",{className:"ml-3 space-y-1",children:[(0,n.jsx)("div",{className:"h-4 bg-gray-300 dark:bg-gray-700 rounded w-24"}),(0,n.jsx)("div",{className:"h-3 bg-gray-300 dark:bg-gray-700 rounded w-16"})]})]})]}),(0,n.jsxs)(a.F,{className:"flex-1 p-4",children:[A&&0===T.length?(0,n.jsx)("div",{className:"flex justify-center items-center h-full",children:(0,n.jsx)(u.TwU,{className:"animate-spin h-6 w-6 text-blue-500"})}):0===T.length?S?(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-gray-500",children:[(0,n.jsx)(u.mEP,{className:"h-12 w-12 mb-2"}),(0,n.jsx)("p",{children:"No messages yet"}),(0,n.jsx)("p",{className:"text-sm",children:"Send a message to start the conversation"})]}):(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-gray-500",children:[(0,n.jsx)(u.mEP,{className:"h-12 w-12 mb-2"}),(0,n.jsx)("p",{children:"Start the conversation"}),(0,n.jsxs)("p",{className:"text-sm",children:["Send your first message to @",null!=(d=null==W?void 0:W.username)?d:"this user","."]})]}):T.map((e,t)=>{var s;let r=e.sender_uid===x.id,i=r||0===t||(null==(s=T[t-1])?void 0:s.sender_uid)!==e.sender_uid,a=L[e.sender_uid];return(0,n.jsx)(w,{message:e,isOwnMessage:r,showAvatar:i,senderProfile:a},e.id)}),(0,n.jsx)("div",{ref:V}),K&&el&&(0,n.jsxs)("div",{className:"px-4 pb-2 text-sm text-gray-500 dark:text-gray-400 animate-pulse",children:[null!=(h=el.username)?h:"User"," is typing..."]})]}),(0,n.jsx)("div",{className:"flex-shrink-0",children:(0,n.jsx)(N,{onSendMessage:e=>{S?er(e):z&&en(z,e)},onTypingChange:(e,t)=>{G.current&&ei(e)},disabled:A||B||!S&&!W})})]}):(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-gray-500 p-4 text-center",children:[(0,n.jsx)(u.mEP,{className:"h-16 w-16 mb-4"}),(0,n.jsx)("p",{className:"text-xl font-semibold mb-2",children:"Your Messages"}),(0,n.jsx)("p",{className:"max-w-md mb-4",children:"Select a conversation from the list or find a user profile to start messaging."})]})})]})}},6951:(e,t,s)=>{Promise.resolve().then(s.bind(s,4304)),Promise.resolve().then(s.bind(s,6349))}},e=>{var t=t=>e(e.s=t);e.O(0,[6711,4206,2666,844,851,3953,6671,1733,3568,8312,1144,4550,7431,3762,4304,8441,1684,7358],()=>t(6951)),_N_E=e.O()}]);